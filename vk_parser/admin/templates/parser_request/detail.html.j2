{% extends "./base.html.j2" %}
{% import "./macros/utils.html.j2" as utils%}
{% block title %}Информация о парсинге{% endblock title%}

{% block content %}

<div class="container">
  <div class="section">
    <div class="row">
      <div class="col s12">
        <h2 class="light-blue-text darken-3">Парсинг №{{ parser_request.id }}</h2>
      </div>
    </div>
    <div class="row">
      <div class="col s6">
        <p>Создан: {{ parser_request.created_at|datetime_format }}</p>
        <p>Статус: <b>{{ parser_request.status }} </b></p>
        <p>Тип парсинга: {{ parser_request.parser_type }}</p>
        <p>Ссылка на группу: <a target="_blank" rel="noopener noreferrer"  href="{{parser_request.input_data['group_url'] }}">{{parser_request.input_data['group_url'] }}</a></p>
        {% if parser_request.error_message %}<p>Ошибка: <b><span class="red-text darken-5">{{parser_request.error_message}}</span></b></p> {% endif%}
        <hr>
      </div>
    </div>
    {% if parser_request.status == "SUCCESSFUL" %}
    <div class="row">
      <div class="col s9">
        <a href="/admin/parsers/{{parser_request.id}}/users/" class="waves-effect waves-light btn-small"><i class="material-icons left">cloud</i>Скачать таблицу пользователей (csv)</a>
        <a href="/api/v1/send_messages/" class="blue waves-effect waves-light btn-small"><i class="material-icons left">cloud</i>Отправить сообщения</a>
        <tr class="waves-efffect">
          <td>
          <form class="col s12" method="post">
            <button class="btn blue waves-effect waves-light" type="submit">Отправить сообщения</button>
          </form></td>
          <td>
          <form class="col s12" method="post" action="start_messages">
            <button class="btn red waves-effect waves-light" type="submit">Удалить пользователей</button>
          </form></td>
        </tr>
      </div>
      <br>
      {% if parser_request.parser_type == "VK_DOWNLOAD_AND_PARSED_POSTS"%}
       <table class="striped highlight">
          <thead>
            <tr>
                <th>VK ID</th>
                <th>Фамилия</th>
                <th>Имя</th>
                <th>Дата рождения</th>
                <th>Последний вход в ВК</th>
                <th>Посты</th>
            </tr>
          </thead>

          <tbody>
            {% for item in user_data %}
            <tr class="waves-efffect">
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{{ item.vk_user_id }}</a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{{ item.first_name }}</a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{{ item.last_name }}</span></a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{% if item.birth_date %}{{ item.birth_date|datetime_format("%d.%m.%Y") }}{% endif %}</a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{% if item.last_visit_vk_date %}{{ item.last_visit_vk_date|datetime_format("%d.%m.%Y") }}{% endif %}</a></td>
              <td>
              {% for post in item.posts %}
              <a class="posts" target="_blank" rel="noopener noreferrer" href="{{ post.url }}">{{ post.text }}</a><br><br>
              {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% elif parser_request.parser_type == "VK_SIMPLE_DOWNLOAD"%}
        <div class="row">
          <div class="col s12">
            <h2 class="light-blue-text darken-3">Список пользователей</h2>
          </div>
          <div class="col s12">
            <p>Всего человек загружено : {{ user_data | length }} </p>
          </div>

        </div>
       <table class="striped highlight">
          <thead>
            <tr>
                <th>VK ID</th>
                <th>Фамилия</th>
                <th>Имя</th>
                <th>Дата рождения</th>
                <th>Последний вход в ВК</th>
            </tr>
          </thead>

          <tbody>
            {% for item in pagination.items %}
            <tr class="waves-efffect">
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{{ item.vk_user_id }}</a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{{ item.first_name }}</a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{{ item.last_name }}</span></a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{% if item.birth_date %}{{ item.birth_date|datetime_format("%d.%m.%Y") }}{% endif %}</a></td>
              <td><a target="_blank" rel="noopener noreferrer" href="https://vk.com/id{{ item.vk_user_id }}">{% if item.last_visit_vk_date %}{{ item.last_visit_vk_date|datetime_format("%d.%m.%Y") }}{% endif %}</a></td>
              <td>
                <span class="delete-icon" onclick="toggleDelete('{{ item.vk_user_id }}', '{{ parser_request.id }}')">&#10006;</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <ul class="pagination">
          {% with page = pagination.meta.page, page_size = pagination.meta.page_size, pages = pagination.meta.pages %}
            {% if page != 1 %}
            <li class="waves-effect">
              <a href="/admin/parsers/{{ parser_request.id }}/?page_size={{ page_size }}&page={{ page - 1 }}">
              <i class="material-icons">chevron_left</i></a>
              </li>
            {%endif%}
            <li class="active"><a href="#!">{{ page }}</a></li>
            {% if page != pages%}
            <li class="waves-effect">
            <a href="/admin/parsers/{{ parser_request.id }}/?page_size={{ page_size }}&page={{ page + 1 }}"><i class="material-icons">chevron_right</i></a>
            </li>
            {%endif%}
          {%endwith%}
        </ul>
        {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<script>
  function toggleDelete(userId, parserId) {
      // Отправка данных на сервер
      fetch('/admin/delete_user/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: userId,
          parserId: parserId
        })
      })
      .then(response => {
        // Обработка ответа от сервера
        console.log(response);
      })
      .catch(error => {
        // Обработка ошибки
        console.error('Ошибка:', error);
      });
  }
</script>

{% endblock %}
